<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Meet Match</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin-dashboard.css' %}">
  <style>
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      width: 50%;
      border-radius: 8px;
      position: relative;
    }

    .close-modal {
      position: absolute;
      right: 20px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .modal-buttons {
      text-align: right;
      margin-top: 20px;
    }

    .modal-buttons button {
      padding: 8px 16px;
      margin-left: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .save-btn {
      background-color: #4CAF50;
      color: white;
    }

    .cancel-btn {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <!-- ‚úÖ Top Navbar -->
  <div class="top-navbar">
    <img src="{% static 'images/base color-wide.svg' %}" alt="Meet Match Logo" class="top-logo" />
  </div>

  <div class="dashboard-container">
    <!-- ‚úÖ Sidebar (Green) -->
    <div class="sidebar">
      <ul class="sidebar-links">
        <li><a href="{% url 'AdminDashboard:admin_dashboard' %}">Dashboard (Home)</a></li>
        <li><a href="#">Interview Scheduling</a></li>
        <li><a href="#">Evaluation Insights</a></li>
        <li class="sidebar-section">Other Information</li>
        <li><a href="{% url 'Questions:questions' %}">Questions Feed</a></li>
        <li><a href="{% url 'AdminDashboard:candidate' %}">Candidates Info</a></li>
        <li><a href="#">Help</a></li>
        <li class="sidebar-section">Settings</li>
        <li><a href="#">Personal Settings</a></li>
      </ul>
    </div>

<!-- ‚úÖ Main Content -->
<div class="main-content">
  <h2 class="dashboard-title">Admin Dashboard</h2>

  <!-- üîç Filters -->
  <form method="get" class="dashboard-filters">
    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search candidates..." class="dashboard-search">

    <select name="field" class="dashboard-select" onchange="this.form.submit()">
      <option value="">All Fields</option>
      {% for field in unique_fields %}
        <option value="{{ field }}" {% if field == selected_field %}selected{% endif %}>{{ field }}</option>
      {% endfor %}
    </select>

    <select name="status" class="dashboard-select" onchange="this.form.submit()">
      <option value="">All Statuses</option>
      {% for status in unique_statuses %}
        <option value="{{ status }}" {% if status == selected_status %}selected{% endif %}>{{ status }}</option>
      {% endfor %}
    </select>
  </form>

    <!-- ü§ñ AI Filtration Button -->
  <form id="aiFilterForm" method="post" action="{% url 'AdminDashboard:ai_filter' %}" class="dashboard-filters">
      {% csrf_token %}
      <button type="submit" class="ai-filter-btn" id="aiFilterBtn">AI Filtration</button>
    </form>

<script>
document.getElementById('aiFilterForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const btn = document.getElementById('aiFilterBtn');
  const progress = document.getElementById('filterProgress');
  btn.disabled = true;
  progress.style.display = 'block';
  progress.innerText = 'Filtering started...';

  fetch(this.action, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  }).then(response => response.body.getReader())
    .then(reader => {
      let decoder = new TextDecoder();
      let buffer = '';

      function read() {
        reader.read().then(({ done, value }) => {
          if (done) {
            progress.innerText = '‚úÖ Filtering completed. Reloading...';
            setTimeout(() => window.location.reload(), 2000);
            return;
          }
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // keep the last incomplete line

          for (const line of lines) {
            if (line.startsWith('PROGRESS:')) {
              progress.innerText = line.replace('PROGRESS:', '').trim();
            }
          }
          read();
        });
      }
      read();
    });
});
</script>


<div id="filterProgress" style="margin-top: 10px; font-weight: bold; display: none;"></div>
  <!-- ‚úÖ Table Form -->
  <div class="dashboard-table">
    <form method="post" action="{% url 'AdminDashboard:delete_selected_candidates' %}">
      {% csrf_token %}
      
      <div class="table-header d-flex justify-content-between align-items-center">
        <h3>Candidates List</h3>
        <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete the selected candidates?');">
          üóë Delete Selected
        </button>
      </div>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" onclick="toggleCheckboxes(this)"></th>
        <th>NAME</th>
        <th>RESUME</th>
        <th>PHONE</th>
        <th>FIELD</th>
        <th>STATUS</th>
        <th>SCORE</th>
        <th>ACTIONS</th>
      </tr>
    </thead>
    <tbody>
      {% for dash in dashboard_data %}
      <tr>
        <td><input type="checkbox" name="selected_ids" value="{{ dash.id }}"></td>
        <td class="name-cell">
          <img src="{{ dash.image.url }}" alt="avatar" class="avatar" />
          <div>
            <div class="candidate-name">{{ dash.name }}</div>
            <div class="candidate-email">{{ dash.mail }}</div>
          </div>
        </td>
        <td>
          {% if dash.cv %}
            <a href="{{ dash.cv.url }}" class="cv-button" target="_blank">üìÑ View CV</a>
          {% else %}
            <span class="cv-missing">N/A</span>
          {% endif %}
        </td>
        <td>{{ dash.phone }}</td>
        <td>{{ dash.fields }}</td>
        <td><span class="status-applied">{{ dash.status }}</span></td>
        <td>{{ dash.evaluation_point }}</td>
        <td>
          <form method="post" action="{% url 'AdminDashboard:delete_candidate' dash.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="action-btn" title="Delete" onclick="return confirm('Delete this candidate?');">
              üóëÔ∏è
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

        <div class="pagination">
          {% if dashboard_data.has_previous %}
            <a href="?page={{ dashboard_data.previous_page_number }}" class="pagination-btn">Previous</a>
          {% endif %}

          {% for num in dashboard_data.paginator.page_range %}
            {% if dashboard_data.number == num %}
              <span class="pagination-btn active">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" class="pagination-btn">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if dashboard_data.has_next %}
            <a href="?page={{ dashboard_data.next_page_number }}" class="pagination-btn">Next</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Edit Candidate</h2>
      <form id="editForm" method="POST">
        {% csrf_token %}
        <input type="hidden" id="candidateId" name="candidate_id">
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
          <label for="mail">Email</label>
          <input type="email" id="mail" name="mail" required>
        </div>
        <div class="form-group">
          <label for="phone">Phone</label>
          <input type="tel" id="phone" name="phone" required>
        </div>
        <div class="form-group">
          <label for="fields">Field</label>
          <input type="text" id="fields" name="fields" required>
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status" required>
            <option value="Completed">Completed</option>
            <option value="Non-Completed">Non-Completed</option>
            <option value="Processing">Processing</option>
          </select>
        </div>
        <div class="form-group">
          <label for="evaluation_point">Evaluation Point</label>
          <input type="number" id="evaluation_point" name="evaluation_point" step="0.1" min="0" max="10" required>
        </div>
        <div class="form-group">
          <label for="image">Profile Image</label>
          <input type="file" id="image" name="image" accept="image/*">
        </div>
        <div class="form-group">
          <label for="cv">CV</label>
          <input type="file" id="cv" name="cv" accept=".pdf,.doc,.docx">
        </div>
        <div class="modal-buttons">
          <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
          <button type="submit" class="save-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Modal functions
    function openEditModal(id, name, mail, phone, fields, status, evaluation_point) {
      document.getElementById('editModal').style.display = 'block';
      document.getElementById('candidateId').value = id;
      document.getElementById('name').value = name;
      document.getElementById('mail').value = mail;
      document.getElementById('phone').value = phone;
      document.getElementById('fields').value = fields;
      document.getElementById('status').value = status;
      document.getElementById('evaluation_point').value = evaluation_point;
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target == document.getElementById('editModal')) {
        closeModal();
      }
    }

    // Handle edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const candidateId = formData.get('candidate_id');

      fetch(`/admin-dashboard/candidate/${candidateId}/edit/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('Candidate updated successfully');
          location.reload();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        alert('Error: ' + error);
      });
    });

    // Handle delete
    function deleteCandidate(id) {
      if (confirm('Are you sure you want to delete this candidate?')) {
        fetch(`/admin-dashboard/candidate/${id}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            alert('Candidate deleted successfully');
            location.reload();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          alert('Error: ' + error);
        });
      }
    }

    // Select All Checkbox Functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.getElementsByClassName('row-checkbox');
        for (let checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
        updateDeleteButton();
    });

    // Individual Checkbox Functionality
    document.querySelectorAll('.row-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateDeleteButton();
            updateSelectAllCheckbox();
        });
    });

    // Update Delete Button Text
      function toggleCheckboxes(source) {
        checkboxes = document.getElementsByName('selected_ids');
        for (let i = 0; i < checkboxes.length; i++) {
          checkboxes[i].checked = source.checked;
        }
      }
    // Update Select All Checkbox State
    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const selectAllCheckbox = document.getElementById('selectAll');
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        
        selectAllCheckbox.checked = checkboxes.length === checkedBoxes.length;
        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < checkboxes.length;
    }
  </script>
</body>
</html>
